module "pbigwvm" {
  source                     = "../../modules12/virtual_machine_universal_win2016"
  vm_region                  = var.location_acronym
  project_name               = "Core"
  application_acronym        = var.application_acronym
  vm_workload_desc           = "PBI"
  vm_environment             = upper(var.environment_acronym_vm)
  resource_group_name        = azurerm_resource_group.hubvnet.name
  resource_group_location    = azurerm_resource_group.hubvnet.location
  tags                       = var.tags_GatewayServices
  subnet_id                  = azurerm_subnet.pbi1.id
  count_value                = var.vm_count_pbi
  need_zones                 = true 
  vm_size                    = var.vm_size_pbi
  data_disk_size             = "0"
  availability_set_id        = module.powerbigatewayas.availability_set_id
  azurerm_image_id           = ""
  storage_uri                = azurerm_storage_account.vmdiagnosticslogs.primary_blob_endpoint
  template_file              = data.template_file.ps1.rendered
  template_file_xml          = data.template_file.xml.rendered
  loganalytics_workspace_id  = azurerm_log_analytics_workspace.hub.workspace_id
  loganalytics_workspace_key = azurerm_log_analytics_workspace.hub.primary_shared_key
  storage_account_name       = azurerm_storage_account.vmdiagnosticslogs.name
  storage_account_key        = azurerm_storage_account.vmdiagnosticslogs.primary_access_key
  client_id                  = data.azurerm_client_config.current.client_id
  diskencryption_keyvault    = azurerm_key_vault.azure_disk_encryption_kv.id
  backup_resource_group_name = azurerm_resource_group.backuprecoveryrgp.name
  recovery_vault_name        = module.recoveryservicevault.services_vault_name
  backup_policy_id           = module.recoveryservicevault.backup_policy_id
  custom_emails              = "go-fmmanagedservices@kpmg.com"
  domain_name                = var.domain_name
  ou_path                    = var.ou_path
  domain_user_name           = var.domain_user_name
  domain_user_password       = var.domain_user_password
  admin_password             = var.admin_password
  encryptappsp_key_password  = var.client_secret
}